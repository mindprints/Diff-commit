# Diff-commit Handoff (2026-02-24)

## Update (2026-02-24)

### Prompting / Prompt UX
- Added prompt-panel starter pills (`Review`, `Analyze`, `Fact-check`, `Rewrite`, `Compress`, `Expand`, `Compose`, `Edit`) that insert editable starter text/commands instead of auto-running.
- Added Prompt Graph `Sort` dropdown (mirrors universal graph pattern) with:
  - `Sort by Name`
  - `Sort by Type`
  - `Sort by Pinned`
  - `Sort by Order`
  - `Reset View`
- Increased prompt title space:
  - wider prompt graph prompt pills
  - wider active-prompt dropdown label in editor header
- Moved Prompt Graph pin dropzone to the **left side** to avoid overlap with top-right controls (e.g. Sort menu).

### Prompt persistence behavior (soft staging)
- Prompt create/update/delete/reset now use **soft staging** in-session (no immediate persistence).
- Staged prompt changes are saved/discarded through the existing Electron close prompt (`Save / Don't Save / Cancel`).
- Window dirty-state now includes staged prompt changes so close prompts appear for prompt-only edits too.

### Model selection / persistence / diagnostics
- Fixed default **text model persistence** for imported OpenRouter models (restore-after-imported-models-load path in `AIContext`).
- Added model ping audit:
  - manual trigger in Settings (`Run Model Ping Audit`)
  - optional auto-run on app startup (enabled by default; user-toggle in Settings)
  - pings **all available models** (not just selected-role models)
  - result popup sorted by latency (successes first, then failures)
- Import Browser improvements:
  - `Show Imported` toggle
  - `Imported` row badge
  - search hint when matching models are hidden because they’re already imported

### OpenRouter image generation path (Flux/OpenRouter compatibility)
- Image generation requests now include `modalities: ["image"]` when calling OpenRouter `/chat/completions`.
- Added OpenRouter bridge/main/preload typings for `modalities`.
- Improved image-generation error reporting (JSON error bodies surfaced).

### OpenRouter import debugging findings (important)
- Verified via direct `/api/v1/models` calls (authenticated + unauthenticated) that in this environment:
  - `bytedance-seed/*` models are returned
  - `black-forest-labs/*` and `sourceful/*` are **not returned**
- Conclusion: those missing providers cannot be imported by the app currently because they are absent from the OpenRouter models catalog response, not because of the UI filters.

### Validation
- `npx tsc --noEmit` passes after the above changes.

## Scope Completed Today
- Continued universal graph replacement work and polished interaction quirks.
- Added project quick actions (delete), repo-level controls (`New Project`, `Merge`, sort dropdown).
- Restored + improved merge workflow in universal graph (Ctrl/Cmd+click ordered selection).
- Added prompt renaming support in the main editor prompt-edit flow (3-tier prompt format).
- Designed and scaffolded repo-level “NotebookLM-style” repo intelligence system.
- Implemented working V1 repo intelligence pipeline:
  - repo indexing (project contents only)
  - lexical retrieval
  - redundancy scan (exact + lexical overlap)
  - grounded model calls for summarize/ask/topic map
  - minimal UI panel (`RepoIntelPanel`)

## Current Behavior (End-of-day)

### Universal Graph (`src/renderer/components/UniversalGraphModal.tsx`)
- Dragging a project to another repo:
  - moves the project
  - flashes the target repo zone
  - **stays on the source repo view** (no auto-switch)
- Hover tooltips render above surrounding project pills (z-index fix).
- Project pills now support:
  - hover trash icon (delete)
  - double-click to open in editor (restored and reliable)
  - Ctrl/Cmd+click multi-select for merge (selection order preserved)
- Header controls now include:
  - `New Project`
  - `Repo Intel`
  - `Merge` / `Merge (N)` (enabled when 2+ selected)
  - `Sort` dropdown (`Sort by Name`, `Sort by Date`, `Reset View`)
- Merge creates a merged project from selected projects in selection order and opens it in editor.

### Project Manager / Universal Graph coordination
- `New Project` from universal graph opens `ProjectsPanel` **on top of** the graph.
- Project manager opened from universal graph starts directly in create mode (no extra click).
- Canceling project manager returns to universal graph.
- Creating/loading project exits universal graph and returns to main editor.

### Prompt editing in main editor
- Prompt edit mode in `EditorPanel` now uses 3 sections:
  - `PROMPT NAME:`
  - `SYSTEM INSTRUCTION:`
  - `TASK:`
- Saving prompt edits updates prompt name as well (rename support).
- Parser remains backward-compatible with older 2-section prompt edit content.

### Repo Intelligence Prototype (`RepoIntelPanel`)
- New repo-scoped analysis UI is available (opened from universal graph).
- Supports:
  - Build/refresh index
  - Summarize repo
  - Ask repo
  - Find redundancy
- V1 index/retrieval scans repo project contents (`content.md`) only.
- Redundancy report currently uses exact hash + lexical token overlap (Jaccard).
- Repo summarize/ask/topics now use grounded OpenRouter model calls with retrieved excerpts in prompt.
- Citations list is retrieval-derived (top retrieved chunks), not yet parsed from exact `[C#]` references in model output.
- Renderer fallback path exists if running app has stale preload without `window.electron.repoIntel` (preload/main restart still recommended).

## Major Files Touched (Today)
- `src/renderer/components/UniversalGraphModal.tsx`
- `src/renderer/components/AppModals.tsx`
- `src/renderer/components/ProjectsPanel.tsx`
- `src/renderer/components/PromptGraphModal.tsx`
- `src/renderer/components/EditorPanel.tsx`
- `src/renderer/components/RepoIntelPanel.tsx` (new)
- `src/renderer/services/repoIntelService.ts` (new)
- `src/renderer/contexts/RepoIntelContext.tsx` (new)
- `src/renderer/hooks/useRepoIntel.ts` (new)
- `src/renderer/contexts/UIContext.tsx`
- `src/renderer/contexts/index.tsx`
- `src/main/repoIntelIndexService.ts` (new)
- `src/main/repoIntelIpc.ts` (new)
- `src/main/index.ts`
- `src/preload/index.ts`
- `src/renderer/electron.d.ts`
- `src/shared/repoIntelTypes.ts` (new)
- `README.md`

## Known Quirks / Follow-up
- Repo intel citations are currently retrieval-based, not exact model-output citation parsing/validation.
- Repo intel cost tracking is not yet wired into `AIContext.updateCost`.
- Repo intel indexing is in-memory only for now (no persisted cache yet).
- Repo intel retrieval is lexical only (no embeddings/hybrid ranking yet).
- Universal graph repo zone dragging still uses window mouse listeners and could be refactored/polished.
- No commit/diff pills in universal graph yet (still deferred).
- **Prompt persistence behavior (soft staging):** Staged prompt changes (create/update/delete/reset) are currently lost on crashes or force-quits because they are only flushed on a clean Electron close dialog. Consider adding periodic auto-persist or a crash-recovery mechanism (e.g., writing mutations to a temporary draft file).

## Validation Run Today
- `npx tsc --noEmit` (passing after changes)

## Suggested Next Steps (Tomorrow)
1. Repo intel hardening:
   - persist repo index cache to disk
   - parse/validate explicit `[C#]` citations from model output
   - wire cost logging/session cost updates
2. Repo intel UX:
   - add `Map Topics` button to `RepoIntelPanel`
   - show index stats (sources/chunks/status) in panel
   - add open-project action from redundancy rows
3. Universal graph merge UX:
   - optional clear “selection mode” hint / keyboard affordance text
   - optional deselect-all action
4. Universal graph roadmap:
   - commit/diff lane integration and quick actions
